<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laredo Neighborhood Map Editor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #161a1e;
            color: #fff;
            height: 100vh;
            display: flex;
        }

        .sidebar {
            width: 350px;
            background: #1a1f23;
            border-right: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h1 {
            font-size: 1.2rem;
            margin-bottom: 8px;
            color: #00c3ff;
        }

        .sidebar-header p {
            font-size: 0.85rem;
            color: #888;
        }

        .controls {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: #2d2d2d;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: #fff;
            font-size: 0.9rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #00c3ff;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00c3ff 0%, #0099cc 100%);
            color: #fff;
        }

        .btn-primary:hover {
            box-shadow: 0 4px 20px rgba(0, 195, 255, 0.3);
        }

        .btn-secondary {
            background: #2d2d2d;
            color: #fff;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .btn-secondary:hover {
            border-color: #00c3ff;
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .btn-success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            background: rgba(16, 185, 129, 0.3);
        }

        .neighborhoods-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .neighborhoods-title {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 12px;
        }

        .neighborhood-item {
            background: #252a30;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .neighborhood-item.active {
            border-color: #00c3ff;
            background: rgba(0, 195, 255, 0.1);
        }

        .neighborhood-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .neighborhood-points {
            font-size: 0.75rem;
            color: #888;
        }

        .neighborhood-actions {
            display: flex;
            gap: 8px;
        }

        .neighborhood-actions button {
            padding: 6px 10px;
            font-size: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            border: none;
            background: #2d2d2d;
            color: #888;
        }

        .neighborhood-actions button:hover {
            color: #fff;
        }

        .neighborhood-actions button.delete:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .export-section {
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        #map {
            flex: 1;
            height: 100vh;
        }

        .instructions {
            background: rgba(0, 195, 255, 0.1);
            border: 1px solid rgba(0, 195, 255, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 0.8rem;
            color: #00c3ff;
        }

        .instructions ol {
            margin-left: 16px;
            margin-top: 8px;
        }

        .instructions li {
            margin-bottom: 4px;
        }

        .coord-display {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            font-family: monospace;
            font-size: 0.75rem;
            color: #888;
            max-height: 100px;
            overflow-y: auto;
        }

        .current-points {
            margin-top: 12px;
        }

        .current-points-title {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 8px;
        }

        .point-item {
            font-family: monospace;
            font-size: 0.75rem;
            color: #00c3ff;
            padding: 4px 0;
        }

        /* Modal for export */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #1e2328;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.1rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-close:hover {
            color: #fff;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .code-block {
            background: #0a0a0a;
            border-radius: 8px;
            padding: 16px;
            font-family: monospace;
            font-size: 0.8rem;
            color: #00c3ff;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .leaflet-container {
            background: #161a1e;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>Laredo Map Editor</h1>
            <p>Click on the map to draw neighborhood boundaries</p>
        </div>

        <div class="controls">
            <div class="instructions">
                <strong>Instructions:</strong>
                <ol>
                    <li>Enter a neighborhood name</li>
                    <li>Click "Start Drawing"</li>
                    <li>Click on the map to add points</li>
                    <li>Click "Finish Neighborhood" when done</li>
                    <li>Repeat for each neighborhood</li>
                </ol>
            </div>

            <div class="form-group">
                <label class="form-label">Neighborhood Name</label>
                <input type="text" class="form-input" id="neighborhoodName" placeholder="e.g. San Isidro">
            </div>

            <button class="btn btn-primary" id="startBtn" onclick="startDrawing()">Start Drawing</button>
            <button class="btn btn-success" id="finishBtn" onclick="finishNeighborhood()" style="display: none;">Finish Neighborhood</button>
            <button class="btn btn-danger" id="cancelBtn" onclick="cancelDrawing()" style="display: none;">Cancel</button>
            <button class="btn btn-secondary" onclick="undoLastPoint()">Undo Last Point</button>

            <div class="current-points" id="currentPoints" style="display: none;">
                <div class="current-points-title">Current Points:</div>
                <div class="coord-display" id="pointsList"></div>
            </div>
        </div>

        <div class="neighborhoods-list">
            <div class="neighborhoods-title">Saved Neighborhoods</div>
            <div id="neighborhoodsList"></div>
        </div>

        <div class="export-section">
            <button class="btn btn-primary" onclick="exportCoordinates()">Export All Coordinates</button>
            <button class="btn btn-secondary" onclick="clearAll()">Clear All</button>
        </div>
    </div>

    <div id="map"></div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Exported Coordinates</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 12px; color: #888; font-size: 0.9rem;">Copy this code and share it with me:</p>
                <div class="code-block" id="exportCode"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="copyToClipboard()">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize map centered on Laredo
        const map = L.map('map', {
            zoomControl: true,
            scrollWheelZoom: true
        }).setView([27.5306, -99.4803], 12);

        // Dark map tiles
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // State
        let isDrawing = false;
        let currentPoints = [];
        let currentPolygon = null;
        let currentMarkers = [];
        let neighborhoods = [];
        let neighborhoodLayers = [];

        // Start drawing a new neighborhood
        function startDrawing() {
            const name = document.getElementById('neighborhoodName').value.trim();
            if (!name) {
                alert('Please enter a neighborhood name first');
                return;
            }

            isDrawing = true;
            currentPoints = [];

            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('finishBtn').style.display = 'block';
            document.getElementById('cancelBtn').style.display = 'block';
            document.getElementById('currentPoints').style.display = 'block';
            document.getElementById('neighborhoodName').disabled = true;

            updatePointsList();
        }

        // Map click handler
        map.on('click', function(e) {
            if (!isDrawing) return;

            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            currentPoints.push([lat, lng]);

            // Add marker
            const marker = L.circleMarker([lat, lng], {
                radius: 6,
                color: '#00c3ff',
                fillColor: '#00c3ff',
                fillOpacity: 1
            }).addTo(map);
            currentMarkers.push(marker);

            // Update polygon
            updateCurrentPolygon();
            updatePointsList();
        });

        // Update the preview polygon
        function updateCurrentPolygon() {
            if (currentPolygon) {
                map.removeLayer(currentPolygon);
            }

            if (currentPoints.length >= 3) {
                currentPolygon = L.polygon(currentPoints, {
                    color: '#00c3ff',
                    fillColor: 'rgba(0, 195, 255, 0.3)',
                    fillOpacity: 1,
                    weight: 2,
                    dashArray: '5, 5'
                }).addTo(map);
            }
        }

        // Update points list display
        function updatePointsList() {
            const list = document.getElementById('pointsList');
            if (currentPoints.length === 0) {
                list.innerHTML = '<span style="color: #666;">Click on the map to add points...</span>';
            } else {
                list.innerHTML = currentPoints.map((p, i) =>
                    `<div class="point-item">${i + 1}. [${p[0].toFixed(6)}, ${p[1].toFixed(6)}]</div>`
                ).join('');
            }
        }

        // Undo last point
        function undoLastPoint() {
            if (!isDrawing || currentPoints.length === 0) return;

            currentPoints.pop();

            // Remove last marker
            if (currentMarkers.length > 0) {
                const marker = currentMarkers.pop();
                map.removeLayer(marker);
            }

            updateCurrentPolygon();
            updatePointsList();
        }

        // Finish and save neighborhood
        function finishNeighborhood() {
            if (currentPoints.length < 3) {
                alert('You need at least 3 points to create a neighborhood');
                return;
            }

            const name = document.getElementById('neighborhoodName').value.trim();

            // Save neighborhood
            neighborhoods.push({
                name: name,
                coords: [...currentPoints]
            });

            // Create permanent polygon
            const polygon = L.polygon(currentPoints, {
                color: '#00c3ff',
                fillColor: 'rgba(0, 195, 255, 0.3)',
                fillOpacity: 1,
                weight: 2
            }).addTo(map);

            polygon.bindTooltip(name, { permanent: true, direction: 'center', className: 'neighborhood-label' });
            neighborhoodLayers.push(polygon);

            // Clear temporary items
            clearTemporary();
            resetUI();
            updateNeighborhoodsList();
        }

        // Cancel drawing
        function cancelDrawing() {
            clearTemporary();
            resetUI();
        }

        // Clear temporary markers and polygon
        function clearTemporary() {
            currentMarkers.forEach(m => map.removeLayer(m));
            currentMarkers = [];

            if (currentPolygon) {
                map.removeLayer(currentPolygon);
                currentPolygon = null;
            }

            currentPoints = [];
            isDrawing = false;
        }

        // Reset UI
        function resetUI() {
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('finishBtn').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('currentPoints').style.display = 'none';
            document.getElementById('neighborhoodName').value = '';
            document.getElementById('neighborhoodName').disabled = false;
        }

        // Update saved neighborhoods list
        function updateNeighborhoodsList() {
            const list = document.getElementById('neighborhoodsList');

            if (neighborhoods.length === 0) {
                list.innerHTML = '<p style="color: #666; font-size: 0.85rem;">No neighborhoods saved yet</p>';
                return;
            }

            list.innerHTML = neighborhoods.map((n, i) => `
                <div class="neighborhood-item">
                    <div>
                        <div class="neighborhood-name">${n.name}</div>
                        <div class="neighborhood-points">${n.coords.length} points</div>
                    </div>
                    <div class="neighborhood-actions">
                        <button class="delete" onclick="deleteNeighborhood(${i})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Delete a neighborhood
        function deleteNeighborhood(index) {
            if (!confirm(`Delete "${neighborhoods[index].name}"?`)) return;

            neighborhoods.splice(index, 1);

            // Remove layer
            if (neighborhoodLayers[index]) {
                map.removeLayer(neighborhoodLayers[index]);
            }
            neighborhoodLayers.splice(index, 1);

            updateNeighborhoodsList();
        }

        // Clear all
        function clearAll() {
            if (!confirm('Clear all neighborhoods?')) return;

            neighborhoods = [];
            neighborhoodLayers.forEach(l => map.removeLayer(l));
            neighborhoodLayers = [];
            clearTemporary();
            resetUI();
            updateNeighborhoodsList();
        }

        // Export coordinates
        function exportCoordinates() {
            if (neighborhoods.length === 0) {
                alert('No neighborhoods to export');
                return;
            }

            const code = neighborhoods.map(n => {
                const coordsStr = n.coords.map(c => `[${c[0].toFixed(6)}, ${c[1].toFixed(6)}]`).join(',\n                    ');
                return `{
    name: '${n.name}',
    coords: [
                    ${coordsStr}
                ]
}`;
            }).join(',\n');

            document.getElementById('exportCode').textContent = code;
            document.getElementById('exportModal').classList.add('active');
        }

        // Close modal
        function closeModal() {
            document.getElementById('exportModal').classList.remove('active');
        }

        // Copy to clipboard
        function copyToClipboard() {
            const code = document.getElementById('exportCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('Copied to clipboard!');
            });
        }

        // Click outside modal to close
        document.getElementById('exportModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // Initialize
        updateNeighborhoodsList();
    </script>
</body>
</html>
